<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>db &mdash; Moduli Generator documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3"/>
    <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7"/>


    <script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html"/>
    <link rel="search" title="Search" href="../search.html"/>
</head>

<body class="wy-body-for-nav">
<div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
        <div class="wy-side-scroll">
            <div class="wy-side-nav-search">


                <a href="../index.html" class="icon icon-home">
                    Moduli Generator
                </a>
                <div role="search">
                    <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
                        <input type="text" name="q" placeholder="Search docs" aria-label="Search docs"/>
                        <input type="hidden" name="check_keywords" value="yes"/>
                        <input type="hidden" name="area" value="default"/>
                    </form>
                </div>
            </div>
            <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
                <p class="caption" role="heading"><span class="caption-text">Documentation:</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../EXAMPLE_INSTALL_SESSION.html">Boostrap
                        Dev Installer</a></li>
                    <li class="toctree-l1"><a class="reference internal"
                                              href="../EXAMPLE_INSTALL_SESSION.html#requirements">Requirements</a></li>
                    <li class="toctree-l1"><a class="reference internal"
                                              href="../EXAMPLE_INSTALL_SESSION.html#configure">Configure</a></li>
                    <li class="toctree-l1"><a class="reference internal" href="../MARIADB.html">MariaDB</a></li>
                </ul>
                <p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../CONFIG.html">module config</a></li>
                    <li class="toctree-l1"><a class="reference internal" href="../DB.html">module db</a></li>
                    <li class="toctree-l1"><a class="reference internal" href="../MODULI_GENERATOR.html">module
                        moduli_generator</a></li>
                    <li class="toctree-l1"><a class="reference internal" href="../TEST.html">module test</a></li>
                </ul>
                <p class="caption" role="heading"><span class="caption-text">Contributing:</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal"
                                              href="../.github/ISSUE_TEMPLATE/bug_report.html">bug_report template</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal"
                                              href="../.github/ISSUE_TEMPLATE/feature_request.html">Feature Request
                        Template</a></li>
                </ul>
                <p class="caption" role="heading"><span class="caption-text">Legal</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../COPYRIGHT.html">Copyright</a></li>
                    <li class="toctree-l1"><a class="reference internal" href="../LICENSE.html">MIT License</a></li>
                </ul>
                <p class="caption" role="heading"><span class="caption-text">Leftovers</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../DATABASE_INTEGRATION.html">Database
                        Integration</a></li>
                    <li class="toctree-l1"><a class="reference internal" href="../MARIADB.html">MariaDB</a></li>
                    <li class="toctree-l1"><a class="reference internal" href="../CHANGELOG.html">Changelog</a></li>
                    <li class="toctree-l1"><a class="reference internal" href="../CHANGELOG_GENERATOR.html">module
                        changelog_generator</a></li>
                    <li class="toctree-l1"><a class="reference internal" href="../README.html">SSH2 Moduli Generator</a>
                    </li>
                </ul>

            </div>
        </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
        <nav class="wy-nav-top" aria-label="Mobile navigation menu">
            <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
            <a href="../index.html">Moduli Generator</a>
        </nav>

        <div class="wy-nav-content">
            <div class="rst-content">
                <div role="navigation" aria-label="Page navigation">
                    <ul class="wy-breadcrumbs">
                        <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
                        <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
                        <li class="breadcrumb-item active">db</li>
                        <li class="wy-breadcrumbs-aside">
                        </li>
                    </ul>
                    <hr/>
                </div>
                <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                    <div itemprop="articleBody">

                        <h1>Source code for db</h1>
                        <div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span
                                class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span
                                class="kn">import</span> <span class="n">PosixPath</span> <span
                                class="k">as</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span
                                class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span
                                class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span
                                class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">mariadb</span><span class="w"> </span><span
                                class="kn">import</span> <span class="p">(</span><span
                                class="n">ConnectionPool</span><span class="p">,</span> <span
                                class="n">Error</span><span class="p">)</span>  <span
                                class="c1"># Add this import</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span
                                class="w"> </span><span class="kn">import</span> <span class="n">ContextManager</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">config</span><span class="w"> </span><span
                                class="kn">import</span> <span class="p">(</span><span
                                class="n">ModuliConfig</span><span class="p">,</span> <span
                                class="n">default_config</span><span class="p">,</span> <span class="n">is_valid_identifier_sql</span><span
                                class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;MariaDBConnector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;parse_mysql_config&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_mysql_config_value&quot;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="parse_mysql_config">
<a class="viewcode-back" href="../stash/DB.html#db.parse_mysql_config">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_mysql_config</span><span
        class="p">(</span><span class="n">mysql_cnf</span><span class="p">)</span> <span class="o">-&gt;</span> <span
        class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span
        class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span
        class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse MySQL/MariaDB configuration file and return a dictionary structure.</span>

<span class="sd">    :param mysql_cnf: Path to config file (str or Path) or file-like object</span>
<span class="sd">    :return: Dictionary with sections and key-value pairs</span>
<span class="sd">    :raises ValueError: If configuration file has parsing errors</span>
<span class="sd">    :raises FileNotFoundError: If file doesn&#39;t exist</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">configparser</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span
        class="kn">import</span> <span class="n">Path</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">mysql_cnf</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="c1"># Handle different input types</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span
        class="o">.</span><span class="n">ConfigParser</span><span class="p">(</span>
        <span class="n">allow_no_value</span><span class="o">=</span><span class="kc">True</span><span
        class="p">,</span>
        <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">strict</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Allow duplicate sections to be merged</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span
        class="n">mysql_cnf</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span
        class="p">):</span>
            <span class="c1"># File-like object (already open file)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">read_file</span><span
        class="p">(</span><span class="n">mysql_cnf</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span
        class="n">mysql_cnf</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span
        class="p">):</span>
            <span class="c1"># File object with name attribute</span>
            <span class="n">config</span><span class="o">.</span><span class="n">read</span><span
        class="p">(</span><span class="n">mysql_cnf</span><span class="o">.</span><span class="n">name</span><span
        class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># String path - check if file exists first</span>
            <span class="n">path_obj</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span
        class="n">mysql_cnf</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path_obj</span><span
        class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span
        class="sa">f</span><span class="s2">&quot;Configuration file not found: </span><span class="si">{</span><span
        class="n">mysql_cnf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Check if file is empty</span>
            <span class="k">if</span> <span class="n">path_obj</span><span class="o">.</span><span class="n">stat</span><span
        class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">==</span> <span
        class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{}</span>

            <span class="n">config</span><span class="o">.</span><span class="n">read</span><span
        class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path_obj</span><span
        class="p">))</span>

        <span class="c1"># Convert to dictionary and clean up comments</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">section_name</span> <span class="ow">in</span> <span
        class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="n">section_name</span><span
        class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span
        class="n">value</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span
        class="n">items</span><span class="p">(</span><span class="n">section_name</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span
        class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Strip inline comments (everything after # including whitespace before it)</span>
                    <span class="n">cleaned_value</span> <span class="o">=</span> <span class="n">re</span><span
        class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s*#.*$&#39;</span><span
        class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span
        class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">section_name</span><span
        class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cleaned_value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">section_name</span><span
        class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">DuplicateSectionError</span> <span
        class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span
        class="s2">&quot;Error parsing configuration file: </span><span class="si">{</span><span class="n">e</span><span
        class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ParsingError</span> <span
        class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span
        class="s2">&quot;Error parsing configuration file: </span><span class="si">{</span><span class="n">e</span><span
        class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span
        class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span
        class="s2">&quot;Error parsing configuration file: </span><span class="si">{</span><span class="n">e</span><span
        class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="c1"># Re-raise FileNotFoundError as-is (don&#39;t wrap in ValueError)</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span
        class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;already exists&quot;</span> <span class="ow">in</span> <span
        class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span
        class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span
        class="sa">f</span><span class="s2">&quot;Error parsing configuration file: </span><span
        class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span
        class="s2">&quot;Error parsing configuration file: </span><span class="si">{</span><span class="n">e</span><span
        class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_mysql_config_value">
<a class="viewcode-back" href="../stash/DB.html#db.get_mysql_config_value">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_mysql_config_value</span><span class="p">(</span><span
        class="n">cnf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span
        class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span
        class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
                           <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span
        class="p">,</span>
                           <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span
        class="p">,</span>
                           <span class="n">default</span><span class="p">:</span> <span class="n">Any</span> <span
        class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span
        class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a specific value from parsed MySQL config dictionary.</span>

<span class="sd">    :param cnf: Parsed config dictionary from parse_mysql_config</span>
<span class="sd">    :param section: Section name</span>
<span class="sd">    :param key: Key name</span>
<span class="sd">    :param default: Default value if not found</span>
<span class="sd">    :return: Config value or default</span>
<span class="sd">    :raises TypeError: If parameters are not of correct type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Type validation - None config should raise TypeError</span>
    <span class="k">if</span> <span class="n">cnf</span> <span class="ow">is</span> <span class="kc">None</span><span
        class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;config cannot be None&quot;</span><span
        class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span
        class="p">(</span><span class="n">cnf</span><span class="p">,</span> <span class="nb">dict</span><span
        class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span
        class="sa">f</span><span class="s2">&quot;config must be dict, got </span><span class="si">{</span><span
        class="nb">type</span><span class="p">(</span><span class="n">cnf</span><span class="p">)</span><span class="o">.</span><span
        class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span
        class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="nb">str</span><span
        class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span
        class="sa">f</span><span class="s2">&quot;section must be string, got </span><span class="si">{</span><span
        class="nb">type</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span
        class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span
        class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span
        class="sa">f</span><span class="s2">&quot;key must be string, got </span><span class="si">{</span><span
        class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span
        class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span
        class="ow">in</span> <span class="n">cnf</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span
        class="n">cnf</span><span class="p">[</span><span class="n">section</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="k">return</span> <span class="n">cnf</span><span class="p">[</span><span class="n">section</span><span
        class="p">][</span><span class="n">key</span><span class="p">]</span></div>



<div class="viewcode-block" id="MariaDBConnector">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MariaDBConnector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides a connection pool and management functions for interacting with a MariaDB database.</span>

<span class="sd">    This class wraps around the MariaDB connection pooling mechanism to offer efficient,</span>
<span class="sd">    manageable access to database connections. It includes context managers for safe and</span>
<span class="sd">    atomic database operations, as well as utility methods for executing queries and managing</span>
<span class="sd">    transactions.</span>

<span class="sd">    :ivar mariadb_cnf: Path to the MariaDB configuration file.</span>
<span class="sd">    :type mariadb_cnf: str</span>
<span class="sd">    :ivar db_name: Name of the target database for operations.</span>
<span class="sd">    :type db_name: str</span>
<span class="sd">    :ivar base_dir: The base directory for storing files or logs.</span>
<span class="sd">    :type base_dir: str</span>
<span class="sd">    :ivar moduli_file_pfx: Prefix for generated file names related to database moduli operations.</span>
<span class="sd">    :type moduli_file_pfx: str</span>
<span class="sd">    :ivar table_name: Name of the table used for database operations.</span>
<span class="sd">    :type table_name: str</span>
<span class="sd">    :ivar view_name: Name of the view related to database queries.</span>
<span class="sd">    :type view_name: str</span>
<span class="sd">    :ivar config_id: Identifier representing a specific configuration instance.</span>
<span class="sd">    :type config_id: str</span>
<span class="sd">    :ivar key_lengths: List of key lengths used for cryptographic or operational purposes.</span>
<span class="sd">    :type key_lengths: List[int]</span>
<span class="sd">    :ivar records_per_keylength: Number of records tied to each key length.</span>
<span class="sd">    :type records_per_keylength: int</span>
<span class="sd">    :ivar moduli_file: Path to the file storing database moduli information.</span>
<span class="sd">    :type moduli_file: Path</span>
<span class="sd">    :ivar delete_records_on_moduli_write: Boolean flag to remove records after writing to the file.</span>
<span class="sd">    :type delete_records_on_moduli_write: bool</span>
<span class="sd">    :ivar delete_records_on_read: Boolean flag to remove records after they are read from the database.</span>
<span class="sd">    :type delete_records_on_read: bool</span>
<span class="sd">    :ivar logger: Logger instance for managing log output for the module.</span>
<span class="sd">    :type logger: Logger</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span
        class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Context manager entry method. When the managed context is entered,</span>
<span class="sd">        this method is called to return the resource or object to be used</span>
<span class="sd">        within the context.</span>

<span class="sd">        :return: The object or resource that should be used within the managed</span>
<span class="sd">            context.</span>
<span class="sd">        :rtype: The same type as the class implementing this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span
        class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles the cleanup process when exiting a context manager for the object. Ensures that</span>
<span class="sd">        the connection pool is properly closed if it exists and logs any errors that occur</span>
<span class="sd">        during this operation.</span>

<span class="sd">        :param exc_type: The exception type if an exception was raised, otherwise None</span>
<span class="sd">        :type exc_type: type | None</span>
<span class="sd">        :param exc_val: The exception value if an exception was raised, otherwise None</span>
<span class="sd">        :type exc_val: Exception | None</span>
<span class="sd">        :param exc_tb: The traceback object if an exception was raised, otherwise None</span>
<span class="sd">        :type exc_tb: TracebackType | None</span>
<span class="sd">        :return: Returns False to re-raise any exception encountered in the context</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pool&#39;</span><span
        class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span
        class="n">pool</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span
        class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Connection pool closed&quot;</span><span
        class="p">)</span>
            <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span
        class="n">err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing connection pool: </span><span
        class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="MariaDBConnector.get_connection">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector.get_connection">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_connection</span><span
        class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span
        class="n">ContextManager</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provides a context manager for safely getting and managing a connection</span>
<span class="sd">        from the connection pool. Ensures the connection is properly closed and</span>
<span class="sd">        returned to the pool after usage.</span>

<span class="sd">        :return: Yields a connection object from the connection pool.</span>
<span class="sd">        :rtype: Connection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span
        class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get_connection</span><span
        class="p">()</span>
            <span class="k">yield</span> <span class="n">connection</span>
        <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span
        class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting connection from pool: </span><span
        class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">connection</span><span class="p">:</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span
        class="p">()</span>  <span class="c1"># Returns connection to pool</span></div>


<div class="viewcode-block" id="MariaDBConnector.transaction">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector.transaction">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">transaction</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span
        class="s2">&quot;MariaDBConnector&quot;</span> <span class="o">=</span> <span class="kc">None</span><span
        class="p">)</span> <span class="o">-&gt;</span> <span class="n">ContextManager</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provides a context manager for handling database transactions. It ensures that the</span>
<span class="sd">        transaction is properly committed or rolled back and manages logging for the process.</span>

<span class="sd">        :param connection: Optional existing connection to be used in the transaction. If not</span>
<span class="sd">            provided, a new connection will be retrieved from the connection pool.</span>
<span class="sd">        :type connection: Optional</span>
<span class="sd">        :return: Yields the database connection within the transaction context.</span>
<span class="sd">        :rtype: ContextManager</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">connection</span><span class="p">:</span>
            <span class="c1"># Use the provided connection</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">connection</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span
        class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Transaction committed&quot;</span><span
        class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span
        class="p">:</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction rolled back due to error: </span><span
        class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get connection from pool</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span
        class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">conn</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span
        class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Transaction committed&quot;</span><span
        class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span
        class="n">err</span><span class="p">:</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span
        class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction rolled back due to error: </span><span
        class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
                    <span class="k">raise</span></div>


<div class="viewcode-block" id="MariaDBConnector.file_writer">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector.file_writer">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">file_writer</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span
        class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ContextManager</span><span
        class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Context manager for safely opening a file for writing.</span>

<span class="sd">        When used, this context manager ensures that the specified file is opened for</span>
<span class="sd">        writing and properly closed after use, even in the event of an error.</span>

<span class="sd">        :param output_file: The path of the file to be written.</span>
<span class="sd">        :type output_file: Path</span>
<span class="sd">        :return: A file handle for writing.</span>
<span class="sd">        :rtype: TextIO</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">output_file</span><span class="o">.</span><span
        class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span
        class="k">as</span> <span class="n">file_handle</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">file_handle</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span
        class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error writing to file </span><span
        class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">: </span><span
        class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
            <span class="k">raise</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span
        class="n">ModuliConfig</span> <span class="o">=</span> <span class="n">default_config</span><span
        class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MariaDBConnector&quot;</span><span
        class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a class instance with provided configuration parameters and sets up a MariaDB</span>
<span class="sd">        connection pool, along with configured logging for module operations.</span>

<span class="sd">        A Detailed connection pool is established using connection parameters parsed from the MariaDB</span>
<span class="sd">        configuration file, ensuring efficient database interaction. Logging is configured for the</span>
<span class="sd">        module using the provided logger in the configuration.</span>

<span class="sd">        :param config: Configuration object containing necessary properties for initialization</span>
<span class="sd">                       such as MariaDB setup, table/view names, logging preferences, and other</span>
<span class="sd">                       settings.</span>
<span class="sd">        :type config: ModuliConfig</span>

<span class="sd">        :raises RuntimeError: If the connection pool creation fails due to database-related issues.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span
        class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="vm">__dict__</span><span
        class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span
        class="p">[</span><span class="s2">&quot;mariadb_cnf&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;db_name&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;base_dir&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;moduli_file_pfx&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;table_name&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;view_name&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;config_id&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;key_lengths&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;records_per_keylength&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;moduli_file&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;delete_records_on_moduli_write&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;delete_records_on_read&quot;</span><span class="p">,</span>
                       <span class="s1">&#39;get_logger()&#39;</span>
                       <span class="p">]:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span
        class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span
        class="p">)</span>

        <span class="c1"># COnfigure Logger for Module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span
        class="n">config</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span
        class="n">name</span> <span class="o">=</span> <span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span
        class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using MariaDB config: </span><span
        class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">mariadb_cnf</span><span
        class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">records_per_keylength</span> <span
        class="o">=</span> <span class="n">config</span><span class="o">.</span><span
        class="n">records_per_keylength</span>

        <span class="n">mysql_cnf</span> <span class="o">=</span> <span class="n">parse_mysql_config</span><span
        class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">mariadb_cnf</span><span
        class="p">)[</span><span class="s2">&quot;client&quot;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create connection pool instead of single connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span
        class="o">=</span> <span class="n">ConnectionPool</span><span class="p">(</span>
                <span class="n">pool_name</span><span class="o">=</span><span
        class="s1">&#39;moduli_pool&#39;</span><span class="p">,</span>
                <span class="n">pool_size</span><span class="o">=</span><span class="mi">10</span><span
        class="p">,</span>  <span class="c1"># Adjust based on your needs</span>
                <span class="n">pool_reset_connection</span><span class="o">=</span><span class="kc">True</span><span
        class="p">,</span>
                <span class="n">host</span><span class="o">=</span><span class="n">mysql_cnf</span><span
        class="p">[</span><span class="s2">&quot;host&quot;</span><span class="p">],</span>
                <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span
        class="p">(</span><span class="n">mysql_cnf</span><span class="p">[</span><span
        class="s2">&quot;port&quot;</span><span class="p">]),</span>
                <span class="n">user</span><span class="o">=</span><span class="n">mysql_cnf</span><span
        class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">],</span>
                <span class="n">password</span><span class="o">=</span><span class="n">mysql_cnf</span><span
        class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">],</span>
                <span class="n">database</span><span class="o">=</span><span class="n">mysql_cnf</span><span
        class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection pool created with size: 10&quot;</span><span
        class="p">)</span>

        <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span
        class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating connection pool: </span><span
        class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span
        class="sa">f</span><span class="s2">&quot;Connection pool creation failed: </span><span class="si">{</span><span
        class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="MariaDBConnector.sql">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector.sql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sql</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span
        class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span
        class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span
        class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fetch</span><span
        class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span
        class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span
        class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes an SQL query with optional parameters and returns the results or</span>
<span class="sd">        affected rows depending on the fetch flag.</span>

<span class="sd">        This method manages database transactions, logs the results or errors, and</span>
<span class="sd">        ensures proper resource cleanup. It also supports parameterized queries</span>
<span class="sd">        for enhanced security against SQL injection.</span>

<span class="sd">        :param query: The SQL query to be executed.</span>
<span class="sd">        :type query: str</span>
<span class="sd">        :param params: Optional tuple of parameters for the query, default is None.</span>
<span class="sd">        :type params: Optional[tuple]</span>
<span class="sd">        :param fetch: A flag indicating whether to fetch and return query results</span>
<span class="sd">            (True) or not (False). Defaults to True.</span>
<span class="sd">        :type fetch: bool</span>
<span class="sd">        :return: A list of results as dictionaries if fetch is True, or None if</span>
<span class="sd">            fetch is False.</span>
<span class="sd">        :rtype: Optional[List[Dict]]</span>
<span class="sd">        :raises RuntimeError: If an error occurs during query execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span
        class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span
        class="p">(</span><span class="n">connection</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span
        class="n">cursor</span><span class="p">(</span><span class="n">dictionary</span><span class="o">=</span><span
        class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span
        class="p">:</span>
                        <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
                            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span
        class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span
        class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span
        class="p">(</span><span class="n">query</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">fetch</span><span class="p">:</span>
                            <span class="n">results</span> <span class="o">=</span> <span class="n">cursor</span><span
        class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query returned </span><span
        class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span
        class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="n">results</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">affected_rows</span> <span class="o">=</span> <span
        class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query affected </span><span
        class="si">{</span><span class="n">affected_rows</span><span class="si">}</span><span
        class="s2"> rows&quot;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span
        class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error executing SQL query: </span><span
        class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query: </span><span
        class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameters: </span><span
        class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span
        class="sa">f</span><span class="s2">&quot;Database query failed: </span><span class="si">{</span><span
        class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MariaDBConnector.execute_select">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector.execute_select">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute_select</span><span
        class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span
        class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span
        class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span
        class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span
        class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span
        class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a SELECT SQL query and returns the results.</span>

<span class="sd">        This method takes an SQL query and optional parameters, executes the query,</span>
<span class="sd">        and fetches the results from the database. The results are returned as a</span>
<span class="sd">        list of dictionaries, where each dictionary corresponds to a row retrieved</span>
<span class="sd">        from the database.</span>

<span class="sd">        :param query: The SQL query to be executed.</span>
<span class="sd">        :type query: str</span>
<span class="sd">        :param params: A tuple of optional parameters to use during query execution,</span>
<span class="sd">            defaults to None.</span>
<span class="sd">        :type params: Optional[tuple]</span>
<span class="sd">        :return: A list of dictionaries representing the rows of the result set.</span>
<span class="sd">        :rtype: List[Dict]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span
        class="n">sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span
        class="n">params</span><span class="p">,</span> <span class="n">fetch</span><span class="o">=</span><span
        class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="MariaDBConnector.execute_update">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector.execute_update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute_update</span><span
        class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span
        class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span
        class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span
        class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span
        class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes an update query on the database and returns the number of rows affected. The</span>
<span class="sd">        method ensures the query is executed within a managed connection and transaction block</span>
<span class="sd">        to maintain database integrity and handle rollback in case of errors.</span>

<span class="sd">        :param query: The SQL query to be executed.</span>
<span class="sd">        :type query: str</span>
<span class="sd">        :param params: Optional parameters to be used with the query.</span>
<span class="sd">        :type params: Optional[tuple]</span>
<span class="sd">        :return: The number of rows affected by the query execution.</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        :raises RuntimeError: If executing the update query fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span
        class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span
        class="p">(</span><span class="n">connection</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span
        class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span
        class="p">:</span>
                        <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
                            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span
        class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span
        class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span
        class="p">(</span><span class="n">query</span><span class="p">)</span>
                        <span class="n">affected_rows</span> <span class="o">=</span> <span class="n">cursor</span><span
        class="o">.</span><span class="n">rowcount</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query affected </span><span
        class="si">{</span><span class="n">affected_rows</span><span class="si">}</span><span
        class="s2"> rows&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">affected_rows</span>

        <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span
        class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error executing update query: </span><span
        class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span
        class="sa">f</span><span class="s2">&quot;Database update failed: </span><span class="si">{</span><span
        class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MariaDBConnector.execute_batch">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector.execute_batch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute_batch</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">:</span> <span
        class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span
        class="n">params_list</span><span class="p">:</span> <span class="n">Optional</span><span
        class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span
        class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span
        class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute multiple SQL queries in a batch with optional parameters.</span>

<span class="sd">        This method allows execution of a series of SQL queries in a batch,</span>
<span class="sd">        using transactions to ensure atomicity of operations. The queries can</span>
<span class="sd">        have associated parameter tuples for execution.</span>

<span class="sd">        :param queries: A list of SQL query strings to be executed in a batch.</span>
<span class="sd">        :type queries: List[str]</span>
<span class="sd">        :param params_list: A list of tuples containing parameters to</span>
<span class="sd">            correspond with each query. If provided, its length should not</span>
<span class="sd">            exceed the length of the queries list. Defaults to None.</span>
<span class="sd">        :type params_list: Optional[List[tuple]]</span>
<span class="sd">        :return: Boolean indicating whether the batch execution was successful.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        :raises RuntimeError: If any error occurs during the execution of</span>
<span class="sd">            the batch queries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span
        class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span
        class="p">(</span><span class="n">connection</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span
        class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span
        class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">query</span> <span
        class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span
        class="n">queries</span><span class="p">):</span>
                            <span class="n">params</span> <span class="o">=</span> <span
        class="n">params_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span
        class="k">if</span> <span class="n">params_list</span> <span class="ow">and</span> <span
        class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span
        class="n">params_list</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
                                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span
        class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span
        class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span
        class="p">(</span><span class="n">query</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully executed </span><span
        class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span
        class="p">)</span><span class="si">}</span><span class="s2"> in batch&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span
        class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error executing batch queries: </span><span
        class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span
        class="sa">f</span><span class="s2">&quot;Batch query execution failed: </span><span class="si">{</span><span
        class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MariaDBConnector._add_without_transaction">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector._add_without_transaction">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_without_transaction</span><span
        class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span
        class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">int</span><span
        class="p">,</span> <span class="n">key_size</span><span class="p">:</span> <span class="nb">int</span><span
        class="p">,</span> <span class="n">modulus</span><span class="p">:</span> <span class="nb">str</span><span
        class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inserts a new record into the database table without wrapping the operation</span>
<span class="sd">        in a transaction. This method directly interacts with the database cursor</span>
<span class="sd">        to execute an INSERT statement for storing the provided installers.</span>

<span class="sd">        :param timestamp: The timestamp for the record being inserted.</span>
<span class="sd">        :type timestamp: int</span>
<span class="sd">        :param key_size: The size of the cryptographic key in bits.</span>
<span class="sd">        :type key_size: int</span>
<span class="sd">        :param modulus: The cryptographic modulus as a string.</span>
<span class="sd">        :type modulus: str</span>
<span class="sd">        :return: The last inserted ID of the record.</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        :raises Error: If there is an issue during the database operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate identifiers</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">is_valid_identifier_sql</span><span
        class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span
        class="p">)</span> <span class="ow">and</span> <span class="n">is_valid_identifier_sql</span><span
        class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span
        class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid database or table name&quot;</span><span
        class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span
        class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span
        class="p">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span
        class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span
        class="o">.</span><span class="n">db_name</span><span class="p">,</span> <span class="bp">self</span><span
        class="o">.</span><span class="n">table_name</span><span class="p">))</span>
                <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;INSERT INTO </span><span
        class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> (timestamp, config_id, size, modulus) VALUES (%s, %s, %s, %s)&quot;</span>
                <span class="n">params_list</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">timestamp</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config_id</span><span class="p">,</span>
                    <span class="n">key_size</span><span class="p">,</span>
                    <span class="n">modulus</span>
                <span class="p">)</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span
        class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params_list</span><span
        class="p">)</span>
                <span class="n">last_id</span> <span class="o">=</span> <span class="n">cursor</span><span
        class="o">.</span><span class="n">lastrowid</span>
                <span class="k">return</span> <span class="n">last_id</span>
        <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span
        class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error inserting candidate: </span><span
        class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
            <span class="k">raise</span>  <span
        class="c1"># Re-raise to let transaction context manager handle rollback</span></div>


<div class="viewcode-block" id="MariaDBConnector.add">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector.add">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span
        class="nb">int</span><span class="p">,</span> <span class="n">key_size</span><span class="p">:</span> <span
        class="nb">int</span><span class="p">,</span> <span class="n">modulus</span><span class="p">:</span> <span
        class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span
        class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inserts a record into a specified database table. The record includes details such</span>
<span class="sd">        as a timestamp, key size, and modulus value. The method validates the database name</span>
<span class="sd">        and table name before attempting to insert installers. If the validation fails or there</span>
<span class="sd">        is an error during the insertion, the operation will fail gracefully.</span>

<span class="sd">        :param timestamp: Timestamp representing the time associated with the record.</span>
<span class="sd">        :type timestamp: int</span>
<span class="sd">        :param key_size: Size of the key (in bits) to be added.</span>
<span class="sd">        :type key_size: int</span>
<span class="sd">        :param modulus: The modulus value to be added.</span>
<span class="sd">        :type modulus: str</span>
<span class="sd">        :return: The identifier of the last inserted row if successful, otherwise 0.</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate identifiers</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">is_valid_identifier_sql</span><span
        class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span
        class="p">)</span> <span class="ow">and</span> <span class="n">is_valid_identifier_sql</span><span
        class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span
        class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid database or table name&quot;</span><span
        class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span
        class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span
        class="p">(</span><span class="n">connection</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span
        class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span
        class="p">:</span>
                        <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span
        class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span
        class="o">.</span><span class="n">db_name</span><span class="p">,</span> <span class="bp">self</span><span
        class="o">.</span><span class="n">table_name</span><span class="p">))</span>
                        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;INSERT INTO </span><span
        class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> (timestamp, config_id, size, modulus) VALUES (%s, %s, %s, %s)&quot;</span>
                        <span class="n">params_list</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">timestamp</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config_id</span><span
        class="p">,</span>
                            <span class="n">key_size</span><span class="p">,</span>
                            <span class="n">modulus</span>
                        <span class="p">)</span>

                        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span
        class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params_list</span><span
        class="p">)</span>
                        <span class="n">last_id</span> <span class="o">=</span> <span class="n">cursor</span><span
        class="o">.</span><span class="n">lastrowid</span>
                        <span class="k">return</span> <span class="n">last_id</span>
        <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span
        class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error inserting candidate: </span><span
        class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="MariaDBConnector.add_batch">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector.add_batch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_batch</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">:</span> <span
        class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">])</span> <span
        class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a batch of records to the specified table within the database.</span>

<span class="sd">        This method validates the database and table names, prepares the SQL query</span>
<span class="sd">        for batch insertion, and attempts to execute the batch operation. If the</span>
<span class="sd">        execution is successful, a log message is generated indicating the number</span>
<span class="sd">        of records successfully added. If an error occurs during the operation,</span>
<span class="sd">        the error is logged, and the function returns False.</span>

<span class="sd">        :param records: A list of tuples, where each tuple represents a record to</span>
<span class="sd">            be inserted. Each record should contain the timestamp, key size, and</span>
<span class="sd">            modulus values.</span>
<span class="sd">        :type records: List[tuple]</span>
<span class="sd">        :return: A boolean indicating whether the batch operation was successful.</span>
<span class="sd">            Returns True if successful, False otherwise.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">is_valid_identifier_sql</span><span
        class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span
        class="p">)</span> <span class="ow">and</span> <span class="n">is_valid_identifier_sql</span><span
        class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span
        class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid database or table name&quot;</span><span
        class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span
        class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span
        class="o">.</span><span class="n">db_name</span><span class="p">,</span> <span class="bp">self</span><span
        class="o">.</span><span class="n">table_name</span><span class="p">))</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                INSERT INTO </span><span class="si">{</span><span class="n">table</span><span
        class="si">}</span><span class="s2"> (timestamp, config_id, size, modulus)</span>
<span class="s2">                VALUES (%s, %s, %s, %s)</span>
<span class="s2">                &quot;&quot;&quot;</span>
        <span class="c1"># Prepare parameters for batch execution</span>
        <span class="n">params_list</span> <span class="o">=</span> <span class="p">[(</span>
            <span class="n">timestamp</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_id</span><span class="p">,</span>
            <span class="n">key_size</span><span class="p">,</span>
            <span class="n">modulus</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">timestamp</span><span class="p">,</span> <span
        class="n">key_size</span><span class="p">,</span> <span class="n">modulus</span> <span
        class="ow">in</span> <span class="n">records</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
        class="n">execute_batch</span><span class="p">([</span><span class="n">query</span><span
        class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span
        class="p">),</span> <span class="n">params_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Successfully added </span><span
        class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">records</span><span
        class="p">)</span><span class="si">}</span><span class="s1"> records to </span><span class="si">{</span><span
        class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="si">}</span><span
        class="s1">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span
        class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">success</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span
        class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error inserting batch records: </span><span
        class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="MariaDBConnector.delete_records">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector.delete_records">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_records</span><span
        class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span
        class="p">,</span> <span class="n">where_clause</span><span class="o">=</span><span class="kc">None</span><span
        class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes records from the specified table in the database, with an optional</span>
<span class="sd">        WHERE clause to filter the records to be deleted. If no WHERE clause is provided,</span>
<span class="sd">        all records in the table will be deleted. The method returns the number of rows</span>
<span class="sd">        affected by the DELETE operation.</span>

<span class="sd">        :param table_name: The name of the table from which records are to be deleted.</span>
<span class="sd">        :type table_name: str</span>
<span class="sd">        :param where_clause: An optional SQL WHERE clause to specify the conditions</span>
<span class="sd">            for the DELETE operation. Defaults to None.</span>
<span class="sd">        :type where_clause: str, optional</span>
<span class="sd">        :return: The number of rows deleted from the table.</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span
        class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span
        class="p">(</span><span class="n">connection</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span
        class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span
        class="p">:</span>
                        <span class="k">if</span> <span class="n">where_clause</span><span class="p">:</span>
                            <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span
        class="s2">&quot;DELETE FROM %s WHERE %s&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span
        class="s2">&quot;DELETE FROM %s&quot;</span>

                    <span class="n">parameter_list</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">table_name</span><span class="p">,</span>
                        <span class="n">where_clause</span>
                    <span class="p">)</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span
        class="p">(</span><span class="n">query</span><span class="p">,</span> <span
        class="n">parameter_list</span><span class="p">)</span>
                    <span class="n">rows_affected</span> <span class="o">=</span> <span class="n">cursor</span><span
        class="o">.</span><span class="n">rowcount</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Moduli Consumed from DB: </span><span
        class="si">{</span><span class="n">rows_affected</span><span class="si">}</span><span
        class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully deleted </span><span
        class="si">{</span><span class="n">rows_affected</span><span class="si">}</span><span class="s2"> rows from table: </span><span
        class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
                    <span class="k">return</span> <span class="n">rows_affected</span>

        <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span
        class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting from table </span><span
        class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">: </span><span
        class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span
        class="sa">f</span><span class="s2">&quot;Error deleting from table </span><span class="si">{</span><span
        class="n">table_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span
        class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MariaDBConnector.export_screened_moduli">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector.export_screened_moduli">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export_screened_moduli</span><span
        class="p">(</span><span class="bp">self</span><span class="p">,</span> <span
        class="n">screened_moduli</span><span class="p">:</span> <span class="nb">dict</span><span
        class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stores screened moduli installers from the given dictionary into the storage.</span>

<span class="sd">        This method iterates over the provided moduli installers, extracting</span>
<span class="sd">        moduli attributes and saving them using an internal method. The operation</span>
<span class="sd">        is performed within a database transaction to ensure atomicity. Errors</span>
<span class="sd">        encountered during the process are logged, and an appropriate status is</span>
<span class="sd">        returned.</span>

<span class="sd">        :param screened_moduli: A dictionary containing moduli installers mapped to corresponding keys.</span>
<span class="sd">        :type screened_moduli: dict</span>
<span class="sd">        :return: An integer indicating the status of the operation,</span>
<span class="sd">                 where 0 indicates success and 1 indicates failure.</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span
        class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span
        class="n">connection</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span
        class="n">transaction</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">moduli_list</span> <span
        class="ow">in</span> <span class="n">screened_moduli</span><span class="o">.</span><span
        class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">modulus</span> <span class="ow">in</span> <span
        class="n">moduli_list</span><span class="p">:</span>
                        <span class="c1"># Use the internal add method without its own transaction</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span
        class="n">_add_without_transaction</span><span class="p">(</span>
                                <span class="n">connection</span><span class="p">,</span>
                                <span class="n">modulus</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span
        class="p">],</span>
                                <span class="n">modulus</span><span class="p">[</span><span class="s2">&quot;key-size&quot;</span><span
        class="p">],</span>
                                <span class="n">modulus</span><span class="p">[</span><span class="s2">&quot;modulus&quot;</span><span
        class="p">]</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span
        class="n">err</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;duplicate&#39;</span> <span
        class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span
        class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Duplicate Modulus, Skipping ...: </span><span
        class="si">{</span><span class="n">modulus</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
                                <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error storing moduli: </span><span
        class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
                                <span class="k">return</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span
        class="n">err</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error storing moduli: </span><span
        class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
                            <span class="k">return</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="MariaDBConnector.write_moduli_file">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector.write_moduli_file">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_moduli_file</span><span
        class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span
        class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes the moduli file using the database interface.</span>

<span class="sd">        This method retrieves the installers necessary for the moduli file from the</span>
<span class="sd">        database and then writes it to the appropriate location using</span>
<span class="sd">        the database interface.</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get the output file path from instance attributes</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="n">Path</span><span
        class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moduli_file</span><span
        class="p">)</span>

            <span class="c1"># Create sizes and counts dictionary based on key_lengths and records_per_keylength</span>
            <span class="n">sizes_and_counts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key_length</span> <span class="ow">in</span> <span class="bp">self</span><span
        class="o">.</span><span class="n">key_lengths</span><span class="p">:</span>
                <span class="n">sizes_and_counts</span><span class="p">[</span><span class="n">key_length</span> <span
        class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span
        class="o">.</span><span class="n">records_per_keylength</span>

            <span class="c1"># Write moduli file directly using the database connection</span>
            <span class="n">total_records</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Validate identifiers</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">is_valid_identifier_sql</span><span
        class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span
        class="p">)</span> <span class="ow">and</span> <span class="n">is_valid_identifier_sql</span><span
        class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">view_name</span><span
        class="p">)):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span
        class="s2">&quot;Invalid database or view name&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span
        class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span
        class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># Write header</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span
        class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span
        class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span
        class="p">()</span> <span class="o">+</span> <span class="s1">&#39;Z&#39;</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span
        class="p">(</span><span class="sa">f</span><span class="s2">&quot;# SSH moduli file generated by moduli_generator at </span><span
        class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="se">\n</span><span
        class="s2">&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">size</span><span class="p">,</span> <span
        class="n">count</span> <span class="ow">in</span> <span class="n">sizes_and_counts</span><span
        class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;=</span> <span
        class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Query moduli for this size</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        SELECT modulus, size, generator, created_at</span>
<span class="s2">                        FROM </span><span class="si">{</span><span class="bp">self</span><span
        class="o">.</span><span class="n">db_name</span><span class="si">}</span><span class="s2">.</span><span
        class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">view_name</span><span
        class="si">}</span>
<span class="s2">                        WHERE size = %s</span>
<span class="s2">                        ORDER BY RAND()</span>
<span class="s2">                        LIMIT %s</span>
<span class="s2">                    &quot;&quot;&quot;</span>

                    <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
        class="n">execute_select</span><span class="p">(</span><span class="n">query</span><span
        class="p">,</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">count</span><span
        class="p">))</span>

                    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span
        class="p">:</span>
                        <span class="c1"># Format as SSH moduli format</span>
                        <span class="n">timestamp_str</span> <span class="o">=</span> <span class="n">record</span><span
        class="p">[</span><span class="s1">&#39;created_at&#39;</span><span class="p">]</span><span
        class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span
        class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span
        class="si">{</span><span class="n">timestamp_str</span><span class="si">}</span><span
        class="s2"> 2 6 100 </span><span class="si">{</span><span class="n">record</span><span class="p">[</span><span
        class="s1">&#39;size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span
        class="si">{</span><span class="n">record</span><span class="p">[</span><span
        class="s1">&#39;generator&#39;</span><span class="p">]</span><span class="si">}</span><span
        class="s2"> </span><span class="si">{</span><span class="n">record</span><span class="p">[</span><span
        class="s1">&#39;modulus&#39;</span><span class="p">]</span><span class="si">}</span><span
        class="se">\n</span><span class="s2">&quot;</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span
        class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="n">total_records</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote </span><span
        class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">records</span><span
        class="p">)</span><span class="si">}</span><span class="s2"> records of size </span><span
        class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully wrote </span><span
        class="si">{</span><span class="n">total_records</span><span class="si">}</span><span class="s2"> moduli records to </span><span
        class="si">{</span><span class="n">output_file</span><span class="si">}</span><span
        class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span
        class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error writing moduli file: </span><span
        class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span
        class="sa">f</span><span class="s2">&quot;Moduli file writing failed: </span><span class="si">{</span><span
        class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MariaDBConnector.stats">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector.stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stats</span><span class="p">(</span><span
        class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span
        class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span
        class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates statistics about moduli files by querying the database for each key size.</span>
<span class="sd">        It calculates the number of available records per key size and potential SSH moduli</span>
<span class="sd">        files based on the configured records per key length.</span>

<span class="sd">        :param self: An instance of the class containing the method.</span>

<span class="sd">        :raises RuntimeError: If the database query fails during execution.</span>
<span class="sd">        :return: A dictionary containing sizes as keys and their respective counts or calculated</span>
<span class="sd">            values as values. The keys represent moduli query sizes, while the values indicate</span>
<span class="sd">            counts or moduli file statistics.</span>
<span class="sd">        :rtype: Dict[str, str]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">moduli_query_sizes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span
        class="bp">self</span><span class="o">.</span><span class="n">key_lengths</span><span class="p">:</span>
            <span class="n">moduli_query_sizes</span><span class="o">.</span><span class="n">append</span><span
        class="p">(</span><span class="n">item</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># First, check if we have enough records for each key size</span>
        <span class="n">status</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span
        class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span
        class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="c1"># Validate identifiers</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">is_valid_identifier_sql</span><span
        class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span
        class="p">)</span> <span class="ow">and</span> <span class="n">is_valid_identifier_sql</span><span
        class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">view_name</span><span
        class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid database or table name&quot;</span><span
        class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">moduli_query_sizes</span><span
        class="p">:</span>
            <span class="c1"># Count query to check available records</span>
            <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span
        class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span
        class="o">.</span><span class="n">db_name</span><span class="p">,</span> <span class="bp">self</span><span
        class="o">.</span><span class="n">table_name</span><span class="p">))</span>
            <span class="n">count_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                                      SELECT COUNT(*)</span>
<span class="s2">                                      FROM </span><span class="si">{</span><span class="n">table</span><span
        class="si">}</span>
<span class="s2">                                      WHERE size = %s</span>
<span class="s2">                                      &quot;&quot;&quot;</span>
            <span class="n">params_list</span> <span class="o">=</span> <span class="p">(</span><span
        class="n">size</span><span class="p">,)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span
        class="o">.</span><span class="n">execute_select</span><span class="p">(</span><span
        class="n">count_query</span><span class="p">,</span> <span class="n">params_list</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span
        class="n">err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error retrieving moduli: </span><span
        class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span
        class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span
        class="sa">f</span><span class="s2">&quot;Database query failed: </span><span class="si">{</span><span
        class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">count</span> <span class="o">=</span> <span class="n">result</span><span
        class="p">[</span><span class="mi">0</span><span class="p">][</span><span
        class="s1">&#39;COUNT(*)&#39;</span><span class="p">]</span>
            <span class="n">status</span><span class="o">.</span><span class="n">append</span><span
        class="p">(</span><span class="n">count</span><span class="p">)</span>

        <span class="c1"># Calculate Number of Moduli Files Available</span>
        <span class="n">status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span
        class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">status</span><span
        class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">records_per_keylength</span><span
        class="p">))</span>
        <span class="n">moduli_query_sizes</span><span class="o">.</span><span class="n">append</span><span
        class="p">(</span><span class="s1">&#39;Available Moduli Files&#39;</span><span class="p">)</span>

        <span class="c1"># Output</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span
        class="p">(</span><span class="nb">zip</span><span class="p">(</span><span
        class="n">moduli_query_sizes</span><span class="p">,</span> <span class="n">status</span><span
        class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span
        class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Moduli statistics:&quot;</span><span
        class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span
        class="n">info</span><span class="p">(</span><span class="s1">&#39;size  count&#39;</span><span
        class="p">)</span>
        <span class="k">for</span> <span class="n">size</span><span class="p">,</span> <span
        class="n">count</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span
        class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span
        class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span
        class="si">{</span><span class="n">size</span><span class="si">:</span><span class="s1">&gt;4</span><span
        class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">count</span><span
        class="si">:</span><span class="s1">&gt;4</span><span class="si">}</span><span class="s1">&#39;</span><span
        class="p">)</span>

        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="MariaDBConnector.stats2">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector.stats2">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stats2</span><span class="p">(</span><span
        class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span
        class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span
        class="p">]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We want</span>
<span class="sd">            Counts by key size</span>
<span class="sd">            Number of potential SSH moduli files based on the configured records per key length.</span>
<span class="sd">            Earliest timestamp for each key size</span>
<span class="sd">            Latest timestamp for each key size</span>

<span class="sd">            To do we need to</span>
<span class="sd">                Collect Counts by key size (Done)</span>
<span class="sd">                Collect earliest timestamp for each key size (tbd)</span>
<span class="sd">                Collect latest timestamp for each key size (tbd)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span
        class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span
        class="o">.</span><span class="n">db_name</span><span class="p">,</span> <span class="bp">self</span><span
        class="o">.</span><span class="n">table_name</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key_length</span> <span class="ow">in</span> <span
        class="bp">self</span><span class="o">.</span><span class="n">key_lengths</span><span class="p">:</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">update</span><span
        class="p">({</span><span class="n">key_length</span><span class="p">:</span> <span class="p">{}})</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">key_length</span><span
        class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span
        class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="p">[]})</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">key_length</span><span
        class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span
        class="s1">&#39;early_stats&#39;</span><span class="p">:</span> <span class="p">[]})</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">key_length</span><span
        class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span
        class="s1">&#39;late_stats&#39;</span><span class="p">:</span> <span class="p">[]})</span>

            <span class="n">counts_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT COUNT(*) FROM </span><span
        class="si">{</span><span class="n">table</span><span class="si">}</span><span
        class="s1"> where size = %s&#39;</span>
            <span class="n">params_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_length</span><span
        class="p">,)</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">key_length</span><span
        class="p">][</span><span class="s1">&#39;counts&#39;</span><span class="p">]</span><span class="o">.</span><span
        class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span
        class="n">execute_select</span><span class="p">(</span><span class="n">counts_query</span><span
        class="p">,</span> <span class="n">params_list</span><span class="p">))</span>

            <span class="n">early_stats_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT MIN(timestamp) FROM </span><span
        class="si">{</span><span class="n">table</span><span class="si">}</span><span
        class="s1"> where size = %s&#39;</span>
            <span class="n">params_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_length</span><span
        class="p">,)</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">key_length</span><span
        class="p">][</span><span class="s1">&#39;early_stats&#39;</span><span class="p">]</span><span class="o">.</span><span
        class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execute_select</span><span
        class="p">(</span>
                    <span class="n">early_stats_query</span><span class="p">,</span>
                    <span class="n">params_list</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;MIN(timestamp)&#39;</span><span
        class="p">])</span>

            <span class="n">late_stats_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT MAX(timestamp) FROM </span><span
        class="si">{</span><span class="n">table</span><span class="si">}</span><span
        class="s1"> where size = %s&#39;</span>
            <span class="n">params_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_length</span><span
        class="p">,)</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">key_length</span><span
        class="p">][</span><span class="s1">&#39;late_stats&#39;</span><span class="p">]</span><span
        class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execute_select</span><span
        class="p">(</span>
                    <span class="n">late_stats_query</span><span class="p">,</span> <span class="n">params_list</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;MAX(timestamp)&#39;</span><span
        class="p">])</span>

        <span class="k">return</span> <span class="n">stats</span></div>


<div class="viewcode-block" id="MariaDBConnector.show_stats">
<a class="viewcode-back" href="../stash/DB.html#db.MariaDBConnector.show_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_stats</span><span class="p">(</span><span
        class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show statistics for moduli in the database - alias for stats method.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span
        class="n">stats</span><span class="p">()</span></div>
</div>

</pre>
                        </div>

                    </div>
                </div>
                <footer>

                    <hr/>

                    <div role="contentinfo">
                        <p>&#169; Copyright 2024,2025 Ronald Williams General Partner, Becker Williams General
                            Partnership.</p>
                    </div>

                    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
                    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
                    provided by <a href="https://readthedocs.org">Read the Docs</a>.


                </footer>
            </div>
        </div>
    </section>
</div>
<script>
    jQuery(function () {
        SphinxRtdTheme.Navigation.enable(true);
    });
</script>

</body>
</html>